### Good version

library(pcalg)
library(graph)

cat("\014") 


data_file <- "D:/OneDrive - Petrovietnam University/PhD/My Research/Paper 2/My codes/Hete_Treatment_Level/inputData/"
data_file <- paste (data_file, 'disability_employment_combined_Rename.csv', sep='')
targetVairable <- 'EMPLOYMENT'
factors <- c('WORK_CAPACITY', 'EDUCATION','LICENCE','MOTIVATION', 'EMAIL')
inputDat <-read.csv(file = data_file)

V<- colnames(inputDat)               
V

suffStat <- list(C = cor(inputDat), n = nrow(inputDat))

## ad gaps
myFixedGaps <- matrix(1:144, nrow=12, ncol=12)

myFixedGaps[] <- FALSE 

# Email-Employment
myFixedGaps[11,12] <- TRUE
myFixedGaps[12,11] <- TRUE

# Email-Allowance
myFixedGaps[11,8] <- TRUE
myFixedGaps[8,11] <- TRUE

# Email-Workcapacity
myFixedGaps[11,3] <- TRUE
myFixedGaps[3,11] <- TRUE

# Email-Licence
myFixedGaps[11,7] <- TRUE
myFixedGaps[7,11] <- TRUE


# Allowance-Licence
myFixedGaps[8,7] <- TRUE
myFixedGaps[7,8] <- TRUE


# Age-Gender
myFixedGaps[1,2] <- TRUE
myFixedGaps[2,1] <- TRUE

# Motivation-Gender
myFixedGaps[10,1] <- TRUE
myFixedGaps[1,10] <- TRUE

# Program-Education
myFixedGaps[5,6] <- TRUE
myFixedGaps[6,5] <- TRUE


# Funding-Education
myFixedGaps[4,6] <- TRUE
myFixedGaps[6,4] <- TRUE


########## Add edges based on domain expert knowledge
myEdges <- matrix(1:144, nrow=12, ncol=12)

myEdges[] <- FALSE

# Education-Employment
myEdges[6,12] <- TRUE
myEdges[12,6] <- TRUE

# Age-Workcapacity
myEdges[2,3] <- TRUE
myEdges[3,2] <- TRUE

# Gender-Workcapacity
myEdges[1,3] <- TRUE
myEdges[3,1] <- TRUE

# Lience-Education
myEdges[7,10] <- TRUE
myEdges[10,7] <- TRUE

res <- pc(suffStat, labels = names(inputDat), indepTest = gaussCItest, 
          fixedGaps = myFixedGaps, fixedEdges = myEdges, alpha = 0.05) #

mygraph = attr(res, 'graph')

nodes(mygraph)

## Re-orientation of the edge to match domain expert knowledge


#### Age --> Disability

mygraph <-removeEdge('DISABILITY', 'AGE', mygraph)
mygraph <-addEdge('AGE', 'DISABILITY', mygraph, 1)


mygraph <-removeEdge('PROGRAM', 'AGE', mygraph)
mygraph <-addEdge('AGE', 'PROGRAM', mygraph, 1)

mygraph <-removeEdge('E_COMMUNICATION', 'EDUCATION', mygraph)
mygraph <-addEdge('EDUCATION', 'E_COMMUNICATION', mygraph, 1)

mygraph <-removeEdge('FUNDING_LEVEL', 'WORK_CAPACITY', mygraph)
mygraph <-addEdge('WORK_CAPACITY', 'FUNDING_LEVEL', mygraph, 1)

mygraph <-removeEdge('FUNDING_LEVEL', 'AGE', mygraph)
mygraph <-addEdge('AGE', 'FUNDING_LEVEL', mygraph, 1)


mygraph <-removeEdge('PROGRAM', 'WORK_CAPACITY', mygraph)
mygraph <-addEdge('WORK_CAPACITY', 'PROGRAM', mygraph, 1)

mygraph <-removeEdge('AGE', 'EMPLOYMENT', mygraph)

#mygraph <-removeEdge('WORK_CAPACITY', 'EMPLOYMENT', mygraph)

mygraph <-removeEdge('EDUCATION', 'MOTIVATION', mygraph)

mygraph <-addEdge('DISABILITY', 'EDUCATION', mygraph, 1)

mygraph <-addEdge('AGE', 'EDUCATION', mygraph, 1)

#mygraph <-removeEdge('WORK_CAPACITY', 'EMPLOYMENT', mygraph)

nA <- list()
nNodes <- length(nodes(mygraph))
nA$fillcolor <- c(EMPLOYMENT="yellow", MOTIVATION="green", EDUCATION="green", WORK_CAPACITY="green")
nA$shape <- c(EMPLOYMENT="box")
nattrs <- list(node=list(shape="ellipse", fixedsize=FALSE, fontsize=20))
plot(mygraph, attrs=nattrs, nodeAttrs=nA)


# Find causes
potentialCauses <- inEdges(targetVairable, mygraph)
causes <- c()
for(cause in potentialCauses[[targetVairable]]){
  
  if( cause %in%  factors){
    causes <- c(causes, cause)
    
  }
  
}

outFilePath <- paste (dirname(getwd()), '/output/Cause/employment/causes.txt', sep='')
write(causes, file = outFilePath, sep = "")
write('==Outcome==Must keep this line to mark outcome variable', file = outFilePath, sep = "", append=TRUE)
write(targetVairable, file = outFilePath, sep = "", append=TRUE)